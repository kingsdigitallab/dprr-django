{% extends "base.html" %}
{% load ddh_utils_tags wagtailbase_tags wagtailcore_tags %}

{% block meta_title %}Person Details{% endblock %}

{% block main %}

<div class="row">
    <div class="large-12 columns">

        <h1>{{ person }}</h1>

        <h2 class="svg-title">Relationships recorded in the sources</h2>

        <p>&nbsp;</p>
        <p>Visualization placeholder</p>

        <!--
        <div class="svg-container">
            <svg xmlns="http://www.w3.org/2000/svg" version="1.1" viewBox="0 0 815 485">
                <g transform="translate(40,0)">
                    <g>
                        <path fill="none" stroke="#330099" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" d="M120,224.664
                            L120,224.664"/>

                            <path fill="none" stroke="#330099" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" stroke-dasharray="0.995,4.9748" d="
                            M125.31,224.441c100.252-6.197,103.002-182.519,204.875-185.894"/>
                        <path fill="none" stroke="#330099" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" d="M333,38.664L333,38.664
                            "/>
                    </g>
                    <g>
                        <path fill="none" stroke="#330099" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" d="M120,224.664
                            L120,224.664"/>

                            <path fill="none" stroke="#330099" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" stroke-dasharray="1.0072,5.0359" d="
                            M125.369,224.498c100.182-4.019,102.964-117.105,204.773-119.302"/>
                        <path fill="none" stroke="#330099" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" d="M333,105.664
                            L333,105.664"/>
                    </g>
                    <path fill="none" stroke="#DF6800" stroke-width="2" d="M119.833,224.608c106.667,0,106.667-52.778,213.333-52.778"/>
                    <path fill="none" stroke="#DF6800" stroke-width="2" d="M119.833,224.608c106.667,0,106.667,13.889,213.333,13.889"/>
                    <path fill="none" stroke="#DF6800" stroke-width="2" d="M119.833,224.608c106.667,0,106.667,113.89,213.333,113.89"/>
                    <g>
                        <path fill="none" stroke="#330099" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" d="M120,224.664
                            L120,224.664"/>
                        <path fill="none" stroke="#330099" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" stroke-dasharray="1.0073,5.0363" d="
                            M125.363,224.82c100.189,7.75,102.968,226.051,204.786,230.281"/>
                        <path fill="none" stroke="#330099" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" d="M332.668,455.162
                            c0.166,0.001,0.332,0.002,0.499,0.002"/>
                    </g>
                    <g>
                        <path fill="none" stroke="#330099" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" d="M332.5,39.5h1"/>
                        <path fill="#330099" stroke="#330099" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" stroke-dasharray="1,5" d="
                            M338.5,39.5h205"/>
                        <path fill="none" stroke="#330099" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" d="M546,38.664
                            C546.166,38.664,546,38.664,546,38.664"/>
                    </g>
                    <g>
                        <path fill="none" stroke="#330099" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" d="M332.5,106.5h1"/>
                        <path fill="none" stroke="#330099" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" stroke-dasharray="1,5" d="
                                M338.5,106.5h205"/>
                        <path fill="none" stroke="#330099" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" d="M546,105.664
                                C546.166,105.664,546,105.664,546,105.664"/>
                    </g>
                    <path fill="#DF6800" stroke="#DF6800" stroke-width="2" d="M332.5,172.5h213"/>
                    <path fill="none" stroke="#DF6800" stroke-width="2" d="M332.5,239.5h213"/>
                    <g>
                        <path fill="none" stroke="#330099" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" d="M332.5,339.5h1"/>
                        <path fill="none" stroke="#330099" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" stroke-dasharray="1.0045,5.0225" d="
                                M338.69,338.469c100.196-1.119,102.972-32.686,204.798-33.296"/>
                        <path fill="none" stroke="#330099" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" d="M546,305.664
                                C546.166,305.664,546,305.664,546,305.664"/>
                    </g>
                    <g>
                        <path fill="none" stroke="#157F00" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" d="M332.5,339.5h3"/>
                        <g>
                            <line fill="#157F00" x1="342.5" y1="338.5" x2="540.5" y2="338.5"/>
                            <g>
                                <line fill="none" stroke="#157F00" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" x1="342.5" y1="338.5" x2="345.5" y2="338.5"/>
                                <line fill="none" stroke="#157F00" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" stroke-dasharray="6,10" x1="355.5" y1="338.5" x2="532.5" y2="338.5"/>
                                <line fill="none" stroke="#157F00" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" x1="537.5" y1="338.5" x2="540.5" y2="338.5"/>
                            </g>
                        </g>
                        <path fill="none" stroke="#157F00" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" d="M542.5,339.5h3"/>
                    </g>
                    <path fill="none" stroke="#DF6800" stroke-width="2" d="M333.167,338.498c106.666,0,106.666,33.332,213.333,33.332"/>
                    <g>
                        <path fill="none" stroke="#330099" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" d="M332.5,456.5h1"/>
                        <path fill="none" stroke="#330099" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" stroke-dasharray="0.9919,4.9593" d="
                                M338.627,455.149c100.271-0.555,103.014-16.347,204.895-16.648"/>
                        <path fill="none" stroke="#330099" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" d="M546,438.664 C546.166,438.664,546,438.664,546,438.664"/>
                    </g>
                    <g>
                        <path fill="none" stroke="#330099" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" d="M332.5,456.5h1"/>
                        <path fill="none" stroke="#330099" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" stroke-dasharray="0.9919,4.9593" d="
                                M338.627,455.179c100.271,0.555,103.014,16.347,204.895,16.648"/>
                        <path fill="none" stroke="#330099" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" d="M546,471.664 C546.166,471.664,546,471.664,546,471.664"/>
                    </g>
                    <g id="{{ person.id }}" transform="translate(213.33333333333337,219.44444444444443)">
                        <circle fill="#EEEEEE" stroke="#999999" stroke-width="2" cx="-93.833" cy="5.22" r="9"/>
                        <text transform="matrix(1 0 0 1 -191.5159 9.1639)" enable-background="new"><tspan x="0" y="0" font-family="'Open Sans Condensed Bold'" font-size="15">C. Iulius (131)</tspan><tspan x="-8" y="18" font-family="'Open Sans Condensed Bold'" font-size="15">C. f. C. n. Caesar</tspan></text>
                    </g>
                    <g transform="translate(426.66666666666674,33.333333333333336)">
                        <circle fill="#EEEEEE" stroke="#999999" cx="-93.5" cy="5.164" r="4.5"/>
                        <text transform="matrix(1 0 0 1 -168.5031 -3.8362)" font-family="'Open Sans Condensed Light Italic'" font-size="14">adoptive father of</text>
                    </g>
                    <g transform="translate(640,33.333333333333336)">
                        <a xlink:href="#" class="svg-link">
                        <circle fill="#9980CC" stroke="#330099" cx="-93.5" cy="5.164" r="4.5"/>
                        <text transform="matrix(1 0 0 1 -85.5 8.1638)" enable-background="new"><tspan x="0" y="0" font-family="'Open Sans Condensed Light'" font-size="16">C. Iulius (132) C. f. C. n. Caesar Octavianus</tspan><tspan x="0" y="19.2" font-family="'Open Sans Condensed Light'" font-size="16">= C. Octavius C. f. Thurinus (or Caepias)</tspan></text>
                        </a>
                    </g>
                    <g transform="translate(426.66666666666674,100)">
                        <circle fill="#EEEEEE" stroke="#999999" cx="-93.5" cy="5.164" r="4.5"/>
                        <text transform="matrix(1 0 0 1 -142.2116 -3.8359)" font-family="'Open Sans Condensed Light Italic'" font-size="14">betrothed to</text>
                    </g>
                    <g transform="translate(640,100)">
                        <a xlink:href="#" class="svg-link">
                            <circle fill="#9980CC" stroke="#330099" cx="-93.5" cy="5.164" r="4.5"/>
                            <text transform="matrix(1 0 0 1 -85.5 8.1641)" font-family="'Open Sans Condensed Light'" font-size="16">-. Cossutia (7)</text>
                        </a>
                    </g>
                    <g transform="translate(426.66666666666674,166.66666666666666)">
                        <circle fill="#EEEEEE" stroke="#999999" cx="-93.5" cy="5.164" r="4.5"/>
                        <text transform="matrix(1 0 0 1 -150.1335 -3.8356)" font-family="'Open Sans Condensed Light Italic'" font-size="14">divorced from</text>
                    </g>
                    <g transform="translate(640,166.66666666666666)">
                        <a xlink:href="#" class="svg-link">
                            <circle fill="#EFB380" stroke="#DF6800" cx="-93.5" cy="5.164" r="4.5"/>
                            <text transform="matrix(1 0 0 1 -85.5 8.1644)" font-family="'Open Sans Condensed Light'" font-size="16">-. Pompeia (52)</text>
                        </a>
                    </g>
                    <g transform="translate(426.66666666666674,233.33333333333334)">
                        <circle fill="#EEEEEE" stroke="#999999" cx="-93.5" cy="5.164" r="4.5"/>
                        <text transform="matrix(1 0 0 1 -123.8581 -3.8362)" font-family="'Open Sans Condensed Light Italic'" font-size="14">father of</text>
                    </g>
                    <g transform="translate(640,233.33333333333334)">
                        <a xlink:href="#" class="svg-link">
                            <circle fill="#EFB380" stroke="#DF6800" cx="-93.5" cy="5.164" r="4.5"/>
                            <text transform="matrix(1 0 0 1 -85.5 8.1638)" font-family="'Open Sans Condensed Light'" font-size="16">-. Iulia (547)</text>
                        </a>
                    </g>
                    <g transform="translate(426.66666666666674,333.3333333333333)">
                        <circle fill="#EEEEEE" stroke="#999999" cx="-93.5" cy="5.165" r="4.5"/>
                        <text transform="matrix(1 0 0 1 -133.0163 -3.8363)" font-family="'Open Sans Condensed Light Italic'" font-size="14">married to</text>
                    </g>
                    <g transform="translate(640,300)">
                        <a xlink:href="#" class="svg-link">
                            <circle fill="#9980CC" stroke="#330099" cx="-93.5" cy="5.164" r="4.5"/>
                            <text transform="matrix(1 0 0 1 -85.5 8.1641)" font-family="'Open Sans Condensed Light'" font-size="16">-. Calpurnia (126)</text>
                        </a>
                    </g>
                    <g transform="translate(640,333.3333333333333)">
                        <a xlink:href="#" class="svg-link">
                            <circle fill="#8ABF80" stroke="#157F00" cx="-93.5" cy="5.165" r="4.5"/>
                            <text transform="matrix(1 0 0 1 -85.5 8.1637)" font-family="'Open Sans Condensed Light'" font-size="16">-. Cornelia (126)</text>
                        </a>
                    </g>
                    <g transform="translate(640,366.66666666666663)">
                        <a xlink:href="#" class="svg-link">
                            <circle fill="#EFB380" stroke="#DF6800" cx="-93.5" cy="5.163" r="4.5"/>
                            <text transform="matrix(1 0 0 1 -85.5 8.1644)" font-family="'Open Sans Condensed Light'" font-size="16">-. Pompeia (143)</text>
                        </a>
                    </g>
                    <g transform="translate(426.66666666666674,450)">
                        <circle fill="#EEEEEE" stroke="#999999" cx="-93.5" cy="5.164" r="4.5"/>
                        <text transform="matrix(1 0 0 1 -113.4655 -3.8359)" font-family="'Open Sans Condensed Light Italic'" font-size="14">son of</text>
                    </g>
                    <g transform="translate(640,433.33333333333337)">
                        <a xlink:href="#" class="svg-link">
                            <circle fill="#9980CC" stroke="#330099" cx="-93.5" cy="5.164" r="4.5"/>
                            <text transform="matrix(1 0 0 1 -85.5 8.1637)" font-family="'Open Sans Condensed Light'" font-size="16">-. Aurelia (248)</text>
                        </a>
                    </g>
                    <g transform="translate(640,466.6666666666667)">
                        <a xlink:href="#" class="svg-link">
                            <circle fill="#9980CC" stroke="#330099" cx="-93.5" cy="5.164" r="4.5"/>
                            <text transform="matrix(1 0 0 1 -85.5 8.1644)" font-family="'Open Sans Condensed Light'" font-size="16">C. Iulius (130) C. f. Caesar</text>
                        </a>
                    </g>
                </g>
                <g>
                    <line fill="none" stroke="#157F00" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" x1="-0.5" y1="64.5" x2="3.5" y2="64.5"/>
                    <line fill="none" stroke="#157F00" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" stroke-dasharray="6,10" x1="13.5" y1="64.5" x2="41.5" y2="64.5"/>
                    <line fill="none" stroke="#157F00" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" x1="46.5" y1="64.5" x2="49.5" y2="64.5"/>
                </g>
                <path fill="none" stroke="#DF6800" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" d="M-0.5,25.5h50"/>
                <g>
                    <line fill="none" stroke="#330099" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" x1="-0.5" y1="44.5" x2="0.5" y2="44.5"/>
                    <line fill="none" stroke="#330099" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" stroke-dasharray="1,5" x1="5.5" y1="44.5" x2="46.5" y2="44.5"/>
                    <line fill="none" stroke="#330099" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" x1="49.5" y1="44.5" x2="49.5" y2="44.5"/>
                </g>
                <text transform="matrix(1 0 0 1 67.4175 28.6235)" font-family="'Open Sans Condensed Light Italic'" font-size="12">Relation recorded in the source for both records</text>
                <text transform="matrix(1 0 0 1 67.4175 48.353)" font-family="'Open Sans Condensed Light Italic'" font-size="12">Relation recorded in the source of the person</text>
                <text transform="matrix(1 0 0 1 67.4175 68.083)" font-family="'Open Sans Condensed Light Italic'" font-size="12">Relation recorded in the source of the related person</text>
                <circle fill="#9980CC" stroke="#330099" cx="55" cy="44.664" r="5"/>
                <circle fill="#EFB380" stroke="#DF6800" cx="55" cy="24.664" r="5"/>
                <circle fill="#8ABF80" stroke="#157F00" cx="55" cy="64.664" r="5"/>
            </svg>
        </div>
        -->

        <!--
        <div class="svg-container">
            <div id="family-graph">
            </div>
        </div>
        -->

        <!--
        <div class="sigma-container">
            <div id="sigma-container">
            </div>
        </div>
        -->

        {% if person.review_flag %}
            <p><b>Warning: person needs revision</b></p>
        {% endif %}

        <p>
            ID: {{ person.id }} <br />

            {% if person.patrician %}
                Patrician: {% if person.patrician_uncertainty %}?{% endif %}{{ person.patrician }} <br />
            {% endif %}
            {% if person.gens %}
                Gens: {% if person.gens_uncertainty %}?{% endif %}{{ person.gens }} <br />
            {% endif %}
        </p>

        <h2>Life Dates</h2>
        <ul>
            {% for di in person.dateinformation_set.all %}
                <li>{{ di }}</li>
            {% endfor %}
        </ul>

        <h2>Offices</h2>
        <ul class="timeline no-bullet bottom-margin">
            {% for pa in person.post_assertions.all %}
                <li><span class="label radius{% if pa.uncertain == True %} gray-bg{% else %} green-bg{% endif %}">{{ pa.print_date | safe}}</span> <strong>{{ pa.office | title}} {% if pa.provinces %} <a href="#">{{ pa.print_provinces }}</a> {% endif %}</strong>

                {% if pa.notes.count %}
                <ul class="no-bullet">
                    {% for note in pa.notes.all %}
                        <li>{{note.text}} (in <em>{{note.secondary_source.abbrev_name}}</em>)</li>
                    {% endfor %}
                </ul>
                {% endif %}

                </li>
            {% endfor %}
        </ul>

    </div>
</div>

<!-- Temp link to d3js.org min and d3 stuff - TO BE REMOVED -->
<script src="//d3js.org/d3.v3.min.js" charset="utf-8"></script>

<!-- d3 graph starts -->
<script>
// TODO:  dynamic height
    var width = 815,
        height = 490,
        viewbox = "0 0 815 490";

    var color = d3.scale.category20();

    var force = d3.layout.force()
        .charge(-120)
        .linkDistance(120)
        .size([width - 20, height - 20]);

    var svg = d3.select("div#family-graph").append("svg")
        //.attr("width", width)
        //.attr("height", height)
        .attr("viewBox", viewbox);

    d3.json("/static/CACHE/json/julius2.json", function(error, graph) {
      if (error) throw error;

      force
        .nodes(graph.nodes)
        .links(graph.links)
        .start();

      var link = svg.selectAll(".link")
        .data(graph.links)
        .enter().append("line")
        .attr("class", "link")
        .style("stroke-width", function(d) { return Math.sqrt(d.value); });

      var node = svg.selectAll(".node")
        .data(graph.nodes)
        .enter().append("circle")
        .attr("class", "node")
        .attr("r", 5)
        .style("fill", function(d) { return color(d.group); })
          .call(force.drag);

      node.append("title")
          .text(function(d) { return d.name; });

      force.on("tick", function() {
        link.attr("x1", function(d) { return d.source.x; })
            .attr("y1", function(d) { return d.source.y; })
            .attr("x2", function(d) { return d.target.x; })
            .attr("y2", function(d) { return d.target.y; });

        node.attr("cx", function(d) { return d.x; })
            .attr("cy", function(d) { return d.y; });
      });
    });
</script>
<!-- d3 graph ends -->

<!-- Sigma js starts -->
<script src="/static/vendor/sigma.js/sigma.min.js"></script>
<script src="/static/vendor/sigma.js/plugins.min.js"></script>


<script>
  // Add a method to the graph model that returns an
  // object with every neighbors of a node inside:
  sigma.classes.graph.addMethod('neighbors', function(nodeId) {
    var k,
        neighbors = {},
        index = this.allNeighborsIndex[nodeId] || {};

    for (k in index)
      neighbors[k] = this.nodesIndex[k];

    return neighbors;
  });

  sigma.parsers.gexf(
    // '/static/CACHE/json/les-miserables.gexf',
    '/static/CACHE/json/les-miserables-iulius.gexf',
    {
      container: 'sigma-container'
    },
    function(s) {
      // We first need to save the original colors of our
      // nodes and edges, like this:
      s.graph.nodes().forEach(function(n) {
        n.originalColor = n.color;
      });
      s.graph.edges().forEach(function(e) {
        e.originalColor = e.color;
      });

      // When a node is clicked, we check for each node
      // if it is a neighbor of the clicked one. If not,
      // we set its color as grey, and else, it takes its
      // original color.
      // We do the same for the edges, and we only keep
      // edges that have both extremities colored.
      s.bind('clickNode', function(e) {
        var nodeId = e.data.node.id,
            toKeep = s.graph.neighbors(nodeId);
        toKeep[nodeId] = e.data.node;

        s.graph.nodes().forEach(function(n) {
          if (toKeep[n.id])
            n.color = n.originalColor;
          else
            n.color = '#eee';
        });

        s.graph.edges().forEach(function(e) {
          if (toKeep[e.source] && toKeep[e.target])
            e.color = e.originalColor;
          else
            e.color = '#eee';
        });

        // Since the data has been modified, we need to
        // call the refresh method to make the colors
        // update effective.
        s.refresh();
      });

      // When the stage is clicked, we just color each
      // node and edge with its original color.
      s.bind('clickStage', function(e) {
        s.graph.nodes().forEach(function(n) {
          n.color = n.originalColor;
        });

        s.graph.edges().forEach(function(e) {
          e.color = e.originalColor;
        });

        // Same as in the previous event:
        s.refresh();
      });
    }
  );
</script>
<!-- Sigma js ends -->

{% endblock %}