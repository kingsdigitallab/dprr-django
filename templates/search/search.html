{% extends "base.html" %}
{% load ddh_utils_tags wagtailbase_tags highlight staticfiles mptt_tags %}

{% block meta_title %}
Search Results{% comment %}{% if query %} for {{ query }}{% endif %}{% endcomment %}
{% endblock %}

{% block headercss %}
    <!-- EasyAutocomplete CSS file -->
    <link rel="stylesheet" href="{% static 'vendor/EasyAutocomplete/dist/easy-autocomplete.min.css' %}">
{% endblock %}

{% block main %}
<div class="row">
    <div class="large-12 columns" id="search">
        <header>
            <h1 id="search-box">Search</h1>
            <button class="small button secondary options"><i class="fa fa-cog"></i> <span id="showhide">Hide</span> search settings</button>
            <a href="/browse/" class="right options"><span class="small button"><i class="fa fa-refresh"></i> Start new search</span></a>
        </header>
        <form method="get" action=".">
            <div class="search-box">
                <section data-section="non-expandable" data-expandable-group-member="facets" id="dprr-filter">
                    <div class="row do-not-print">
                        <div class="large-12 columns">
                            <h4>Refine your search</h4>
                        </div>
                    </div>
                    <div class="row">
                        <div class="large-12 columns">
                            <div class="panel results-preview" data-magellan-expedition="fixed">
                                <h4>Search results
                                <a href="#search-results-box" class="less-padding button right do-not-print">Show <strong>{{ paginator.count }}</strong> results</a></h4>
                                {% comment %}
                                <p class="info"><i class="fa fa-info-circle"></i> Some info on this section.</p>
                                {% endcomment %}
                                <h3>
                                    <strong>{{ paginator.count }}</strong> records available based on your filters <a href="{% url 'haystack_search' %}#search" class="do-not-print"><i class="fa fa-trash"></i> Clear all</a>
                                </h3>

                                {% if query or selected_facets or date_filter or praenomen or nomen or cognomen or other_names or re_number or n or f or other_names %}
                                <ul class="inline-list no-bullet free-filters">
                                    {% if praenomen %}
                                    <li>
                                        <span class="label radius">
                                            <a href="{{ praenomen.0 }}#search" title="Remove filter">Praenomen: {{ praenomen.1 }}
                                                <i class="fa fa-times-circle"></i>
                                            </a>
                                        </span>
                                    </li>
                                    {% endif %}
                                    {% if nomen %}
                                    <li>
                                        <span class="label radius">
                                            <a href="{{ nomen.0 }}#search" title="Remove filter">Nomen: {{ nomen.1 }}
                                                <i class="fa fa-times-circle"></i>
                                            </a>
                                        </span>
                                    </li>
                                    {% endif %}
                                    {% if cognomen %}
                                    <li>
                                        <span class="label radius">
                                            <a href="{{ cognomen.0 }}#search" title="Remove filter">Cognomen: {{ cognomen.1 }}
                                                <i class="fa fa-times-circle"></i>
                                            </a>
                                        </span>
                                    </li>
                                    {% endif %}
                                    {% if re_number %}
                                    <li>
                                        <span class="label radius">
                                            <a href="{{ re_number.0 }}#search" title="Remove filter">RE Number: {{ re_number.1 }}
                                                <i class="fa fa-times-circle"></i>
                                            </a>
                                        </span>
                                    </li>
                                    {% endif %}
                                    {% if f %}
                                    <li>
                                        <span class="label radius">
                                            <a href="{{ f.0 }}#search" title="Remove filter">f.: {{ f.1 }}
                                                <i class="fa fa-times-circle"></i>
                                            </a>
                                        </span>
                                    </li>
                                    {% endif %}
                                    {% if n %}
                                    <li>
                                        <span class="label radius">
                                            <a href="{{ n.0 }}#search" title="Remove filter">n.: {{ n.1 }}
                                                <i class="fa fa-times-circle"></i>
                                            </a>
                                        </span>
                                    </li>
                                    {% endif %}
                                    {% if other_names %}
                                    <li>
                                        <span class="label radius">
                                            <a href="{{ other_names.0 }}#search" title="Remove filter">Additional Cognomina: {{ other_names.1 }}
                                                <i class="fa fa-times-circle"></i>
                                            </a>
                                        </span>
                                    </li>
                                    {% endif %}
                                    {% if query %}
                                    <li>
                                        <span class="label radius">
                                            <a href="{{ remove_text_filter }}#search" title="Remove filter">Text: {{ query }}
                                                <i class="fa fa-times-circle"></i>
                                            </a>
                                        </span>
                                    </li>
                                    {% endif %}
                                    {% if date_filter %}
                                    <li>
                                        <span class="label radius">
                                            <a href="{{ date_filter.0}}#search" title="Remove filter">Post Date: {{ date_filter.1 }}
                                                <i class="fa fa-times-circle"></i>
                                            </a>
                                        </span>
                                    </li>
                                    {% endif %}
                                    {% for facet in selected_facets %}
                                    <li>
                                        <span class="label radius">
                                            {{ facet }}
                                            <a href="{% remove_facet_link querydict facet %}#search">
                                                <i class="fa fa-times-circle"></i>
                                            </a>
                                        </span>
                                    </li>
                                    {% endfor %}
                                </ul>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    <div class="row do-not-print">
                        <div class="large-12 columns">
                            <div class="panel callout">
                                <h3 class="panel-heading">Name</h3>
                                <p class="info"><i class="fa fa-info-circle"></i> Autocomplete suggestions will appear once you start typing</p>
                                <div class="row name-row hyphen">
                                    <div class="medium-1 columns">
                                        {{ form.praenomen }}
                                        <label>Praenomen</label>
                                    </div>
                                    <div class="medium-2 columns">
                                        {{ form.nomen }}
                                        <label>Nomen</label>
                                    </div>
                                    <div class="medium-1 columns">
                                        {{ form.re_number }}
                                        <label>RE</label>
                                    </div>
                                    <div class="medium-1 columns">
                                        {{ form.f }}
                                        <label>Father</label>
                                    </div>
                                    <div class="medium-1 columns">
                                        {{ form.n }}
                                        <label>Grandfather</label>
                                    </div>
                                    <div class="medium-2 columns">
                                        
                                        <button data-dropdown="tribes" aria-controls="tribes" aria-expanded="false" class="secondary less-padding button expand dropdown">Tribe</button>
                                        <br>
                                        <ul id="tribes" data-dropdown-content class="f-dropdown drop-list" role="menu" aria-hidden="false" tabindex="-1">
                                            {% for term in facets.fields|get_item:"tribe" %}
                                            {% with value=term.0 count=term.1 %}
                                            {% if count > 0 %}
                                            <li><a href="{% add_facet_link querydict "tribe" value %}#search"><span class="secondary label radius right">{{ count }}</span>{{ value }}</a></li>
                                            {% endif %}
                                            {% endwith %}
                                            {% endfor %}
                                        </ul>

                                        <label>Tribe</label>
                                    </div>
                                    <div class="medium-2 columns">
                                        {{ form.cognomen }}
                                        <label>Cognomen</label>
                                    </div>
                                    <div class="medium-2 columns">
                                        {{ form.other_names }}
                                        <label>Additional Cognomina</label>
                                    </div>
                                </div>
                            </div>
                            <div class="panel callout">
                                <h3 class="panel-heading">Personal data</h3>
                                <p class="info"><i class="fa fa-info-circle"></i> Some info on this section</p>
                                {{ form.date_from.errors }} {{ form.date_to.errors }}
                                <div class="row range">
                                    <div class="medium-2 columns">
                                        <h4><br>Life Dates:</h4>
                                    </div>
                                    <div class="medium-4 columns">
                                        <label>After</label>
                                        {{ form.date_from }}
                                    </div>
                                    <div class="medium-4 columns">
                                        <label>Before</label>
                                        {{ form.date_to }}
                                    </div>
                                    <div class="medium-2 columns">
                                        <label>&nbsp;</label>
                                        <button type="submit" class="less-padding expand secondary">Apply</button>
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="medium-3 columns">
                                        <ul class="stack button-group">
                                            {% for term in facets.fields|get_item:"gender" %}
                                            {% with value=term.0 count=term.1 %}
                                            {% if count > 0 %}
                                            <li>
                                                <a href="{% add_facet_link querydict "gender" value %}#search" class="button secondary less-padding smaller-fontsize text-left">
                                                    {{ value }}&nbsp;<span class="label radius right">{{ count }}</span>
                                                </a>
                                            </li>
                                            {% endif %}
                                            {% endwith %}
                                            {% endfor %}
                                        </ul>
                                    </div>
                                    <div class="medium-4 medium-offset-1 columns">
                                        <ul class="stack button-group">
                                            {% for term in facets.fields|get_item:"life_date_types" %}
                                            {% with value=term.0 count=term.1 %}
                                            <li>
                                                <a href="{% add_facet_link querydict "life_date_types" value %}#search" class="button secondary less-padding smaller-fontsize text-left">
                                                    {{ value|title }}&nbsp;<span class="label radius right">{{ count }}</span>
                                                </a>
                                            </li>
                                            {% endwith %}
                                            {% endfor %}
                                        </ul>
                                    </div>
                                    <div class="medium-3 medium-offset-1 columns">
                                        <ul class="stack button-group">
                                            {% for term in facets.fields|get_item:"life_date_types" %}
                                            {% with value=term.0 count=term.1 %}
                                            <li>
                                                <a href="{% add_facet_link querydict "life_date_types" value %}#search" class="button secondary less-padding smaller-fontsize text-left">
                                                    {{ value|title }}&nbsp;<span class="label radius right">{{ count }}</span>
                                                </a>
                                            </li>
                                            {% endwith %}
                                            {% endfor %}
                                        </ul>
                                    </div>
                                </div>

                                <div class="row top-padding">
                                    <div class="medium-4 columns">
                                        <h4>Rank</h4>

                                        <ul class="button-group">
                                            {% for term in facets.fields|get_item:"eques" %}
                                            {% with value=term.0 count=term.1 %}
                                            {% if value == "true" and count > 0 %}
                                            <li>
                                                <a href="{% add_facet_link querydict "eques" value %}#search" class="button secondary less-padding">Eques R. <span class="label radius">{{ count }}</span></a>
                                            </li>
                                            {% endif %}
                                            {% endwith %}
                                            {% endfor %}

                                            {% for term in facets.fields|get_item:"senator" %}
                                            {% with value=term.0 count=term.1 %}
                                            {% if value == "true" and count > 0 %}
                                            <li>
                                                <a href="{% add_facet_link querydict "senator" value %}#search" class="button secondary less-padding">Senator <span class="label radius">{{ count }}</span></a>
                                            </li>
                                            {% endif %}
                                            {% endwith %}
                                            {% endfor %}
                                        </ul>
                                    </div>

                                    <div class="medium-8 columns">
                                        <h4>Status</h4>
                                        <ul class="button-group">
                                            {% for term in facets.fields|get_item:"nobilis" %}
                                            {% with value=term.0 count=term.1 %}
                                            {% if value == "true" and count > 0 %}
                                            <li>
                                                <a href="{% add_facet_link querydict "nobilis" value %}#search" class="button secondary less-padding">Nobilis <span class="label radius">{{ count }}</span></a>
                                            </li>
                                            {% endif %}
                                            {% endwith %}
                                            {% endfor %}

                                            {% for term in facets.fields|get_item:"novus" %}
                                            {% with value=term.0 count=term.1 %}
                                            {% if value == "true" and count > 0 %}
                                            <li>
                                                <a href="{% add_facet_link querydict "novus" value %}#search" class="button secondary less-padding">Novus <span class="label radius">{{ count }}</span></a>
                                            </li>
                                            {% endif %}
                                            {% endwith %}
                                            {% endfor %}

                                            {% for term in facets.fields|get_item:"patrician" %}
                                            {% with value=term.0 count=term.1 %}
                                            {% if value == "true" and count > 0 %}
                                            <li>
                                                <a href="{% add_facet_link querydict "patrician" value %}#search" class="button secondary less-padding">Patrician <span class="label radius">{{ count }}</span></a>
                                            </li>
                                            {% endif %}
                                            {% endwith %}
                                            {% endfor %}
                                        </ul>
                                    </div>
                                </div>

                                {% comment %}
                                {# 
                                    This form was attached to the Tribe filter
                                    but it's not used anymore.
                                #}
                                <div class="row">
                                    <div class="large-6 columns">
                                        <div class="row collapse">
                                            <div class="small-9 columns">
                                                <input type="text" name="origin" placeholder="Search for origin">
                                            </div>
                                            <div class="small-3 columns">
                                                <button type="submit" class="postfix secondary button"><i class="fa fa-search"></i></button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                {% endcomment %}
                            </div>
                        </div>
                    </div>
                    <div class="row do-not-print">
                        <div class="large-12 columns">
                            <div class="panel callout">
                                <h3 class="panel-heading">Career</h3>
                                <p class="info"><i class="fa fa-info-circle"></i> Time frame: 509 B.C. - 31 B.C.</p>
                                {{ form.date_from.errors }} {{ form.date_to.errors }}
                                <div class="row range">
                                    <div class="medium-2 columns">
                                        <h4><br>Career Dates:</h4>
                                    </div>
                                    <div class="medium-4 columns">
                                        <label>After</label>
                                        {{ form.date_from }}
                                    </div>
                                    <div class="medium-4 columns">
                                        <label>Before</label>
                                        {{ form.date_to }}
                                    </div>
                                    <div class="medium-2 columns">
                                        <label>&nbsp;</label>
                                        <button type="submit" class="less-padding expand secondary">Apply</button>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="medium-6 large-3 columns">
                                        <div class="panel radius fixed-height">
                                            <h4>Magistracies Offices</h4>
                                            <ul class="no-bullet hierarchical-facets">

                                            {% comment %}
                                              Add options for the hierarchical facets:
                                              using the MPTT template tags to rebuild the tree:
                                                    https://django-mptt.github.io/django-mptt/templates.html
                                            {% endcomment %}

                                            {% with treenodes=office_list %}
                                            {% recursetree treenodes %}

                                            {% with num=office_fdict|lookup:node.name %}

                                            {% if num %}
                                                {% comment %} parent node {% endcomment %}
                                                {% if not node.is_leaf_node %}
                                                <li><span class="label radius pull-right">{{office_fdict|lookup:node.name}}</span>

                                                    <a href="{% select_facet_link 'offices' node.name %}"><span class="label radius secondary pull-right">Add all</span></a>
                                                    <a class="show expander" href="#"><i class="fa fa-caret-right"></i> {{ node.name }}</a>
                                                    <ul class="hide collapsible">
                                                        {{ children }}
                                                    </ul>
                                                </li>
                                                {% else %}
                                                {% comment %} no children {% endcomment %}
                                                <li><a href="{% select_facet_link 'offices' node.name %}"><span class="label radius pull-right">{{num}}</span>&nbsp;&nbsp;{{ node.name }}</a></li>
                                                {% endif %}
                                            {% endif %}
                                            {% endwith %}
                                            {% endrecursetree %}
                                            {% endwith %}
                                            {% comment %} closes the with treenodes {% endcomment %}
                                            </ul>
                                        </div>
                                    </div>
                                    <div class="medium-6 large-3 columns">
                                        <div class="panel radius fixed-height">
                                            <h4>Priesthoods Offices</h4>
                                            <ul class="no-bullet hierarchical-facets">

                                            {% comment %}
                                              Add options for the hierarchical facets:
                                              using the MPTT template tags to rebuild the tree:
                                                    https://django-mptt.github.io/django-mptt/templates.html
                                            {% endcomment %}

                                            {% with treenodes=office_list %}
                                            {% recursetree treenodes %}

                                            {% with num=office_fdict|lookup:node.name %}

                                            {% if num %}
                                                {% comment %} parent node {% endcomment %}
                                                {% if not node.is_leaf_node %}
                                                <li><span class="label radius pull-right">{{office_fdict|lookup:node.name}}</span>

                                                    <a href="{% select_facet_link 'offices' node.name %}"><span class="label radius secondary pull-right">Add all</span></a>
                                                    <a class="show expander" href="#"><i class="fa fa-caret-right"></i> {{ node.name }}</a>
                                                    <ul class="hide collapsible">
                                                        {{ children }}
                                                    </ul>
                                                </li>
                                                {% else %}
                                                {% comment %} no children {% endcomment %}
                                                <li><a href="{% select_facet_link 'offices' node.name %}"><span class="label radius pull-right">{{num}}</span>&nbsp;&nbsp;{{ node.name }}</a></li>
                                                {% endif %}
                                            {% endif %}
                                            {% endwith %}
                                            {% endrecursetree %}
                                            {% endwith %}
                                            {% comment %} closes the with treenodes {% endcomment %}
                                            </ul>
                                        </div>
                                    </div>
                                    <div class="medium-6 large-3 columns">
                                        <div class="panel radius fixed-height">
                                            <h4>Promagistracies Offices</h4>
                                            <ul class="no-bullet hierarchical-facets">

                                            {% comment %}
                                              Add options for the hierarchical facets:
                                              using the MPTT template tags to rebuild the tree:
                                                    https://django-mptt.github.io/django-mptt/templates.html
                                            {% endcomment %}

                                            {% with treenodes=office_list %}
                                            {% recursetree treenodes %}

                                            {% with num=office_fdict|lookup:node.name %}

                                            {% if num %}
                                                {% comment %} parent node {% endcomment %}
                                                {% if not node.is_leaf_node %}
                                                <li><span class="label radius pull-right">{{office_fdict|lookup:node.name}}</span>

                                                    <a href="{% select_facet_link 'offices' node.name %}"><span class="label radius secondary pull-right">Add all</span></a>
                                                    <a class="show expander" href="#"><i class="fa fa-caret-right"></i> {{ node.name }}</a>
                                                    <ul class="hide collapsible">
                                                        {{ children }}
                                                    </ul>
                                                </li>
                                                {% else %}
                                                {% comment %} no children {% endcomment %}
                                                <li><a href="{% select_facet_link 'offices' node.name %}"><span class="label radius pull-right">{{num}}</span>&nbsp;&nbsp;{{ node.name }}</a></li>
                                                {% endif %}
                                            {% endif %}
                                            {% endwith %}
                                            {% endrecursetree %}
                                            {% endwith %}
                                            {% comment %} closes the with treenodes {% endcomment %}
                                            </ul>
                                        </div>
                                    </div>
                                    <div class="medium-6 large-3 columns">
                                        <div class="panel radius fixed-height">
                                            <h4>Lower Offices</h4>
                                            <ul class="no-bullet hierarchical-facets">

                                            {% comment %}
                                              Add options for the hierarchical facets:
                                              using the MPTT template tags to rebuild the tree:
                                                    https://django-mptt.github.io/django-mptt/templates.html
                                            {% endcomment %}

                                            {% with treenodes=office_list %}
                                            {% recursetree treenodes %}

                                            {% with num=office_fdict|lookup:node.name %}

                                            {% if num %}
                                                {% comment %} parent node {% endcomment %}
                                                {% if not node.is_leaf_node %}
                                                <li><span class="label radius pull-right">{{office_fdict|lookup:node.name}}</span>

                                                    <a href="{% select_facet_link 'offices' node.name %}"><span class="label radius secondary pull-right">Add all</span></a>
                                                    <a class="show expander" href="#"><i class="fa fa-caret-right"></i> {{ node.name }}</a>
                                                    <ul class="hide collapsible">
                                                        {{ children }}
                                                    </ul>
                                                </li>
                                                {% else %}
                                                {% comment %} no children {% endcomment %}
                                                <li><a href="{% select_facet_link 'offices' node.name %}"><span class="label radius pull-right">{{num}}</span>&nbsp;&nbsp;{{ node.name }}</a></li>
                                                {% endif %}
                                            {% endif %}
                                            {% endwith %}
                                            {% endrecursetree %}
                                            {% endwith %}
                                            {% comment %} closes the with treenodes {% endcomment %}
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="large-12 columns">
                                        <div class="panel radius fixed-height">
                                            <h4>Province</h4>
                                            <ul class="no-bullet hierarchical-facets">

                                                {% comment %}
                                                  Add options for the hierarchical facets:
                                                  using the MPTT template tags to rebuild the tree:
                                                        https://django-mptt.github.io/django-mptt/templates.html
                                                {% endcomment %}

                                                {% with treenodes=province_list %}
                                                {% recursetree treenodes %}

                                                {% with num=province_fdict|lookup:node.name %}

                                                {% if num %}
                                                {% comment %} parent node {% endcomment %}
                                                {% if not node.is_leaf_node %}
                                                <li><span class="label radius pull-right">{{province_fdict|lookup:node.name}}</span>

                                                    <a href="{% select_facet_link 'province' node.name %}"><span class="label radius secondary pull-right">Add all</a>
                                                    <a class="show expander" href="#"><i class="fa fa-caret-right"></i> {{ node.name }}</a>
                                                    <ul class="hide collapsible">
                                                        {{ children }}
                                                    </ul>
                                                </li>
                                                {% else %}
                                                {% comment %} no children {% endcomment %}
                                                <li><a href="{% select_facet_link 'province' node.name %}"><span class="label radius pull-right">{{num}}</span>&nbsp;&nbsp;{{ node.name }}</a></li>
                                                {% endif %}
                                                {% endif %}
                                                {% endwith %}
                                                {% endrecursetree %}
                                                {% endwith %}
                                                {% comment %} closes the with treenodes {% endcomment %}
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row do-not-print">
                        <div class="large-6 columns">
                            <h4>Text search</h4>
                            <div class="row collapse">
                                <div class="small-9 columns">
                                    {{ form.q }}
                                </div>
                                <div class="small-3 columns">
                                    <button type="submit" class="postfix button"><i class="fa fa-search"></i></button>
                                </div>
                            </div>
                        </div>
                        <div class="large-3 large-offset-3 columns">
                            <h4>&nbsp;</h4>
                            <a href="#search-results-box" class="less-padding expand button">Show <strong>{{ paginator.count }}</strong> results</a>
                        </div>
                    </div>
                </section>
            </div>
        </form>
    </div>
</div>
<div class="row" id="search-results-box">
    <div class="large-12 columns">
        <hr>
        <h2>
            Search Results <span class="label radius">{{ paginator.count }}</span> 
            <a href="#search" class="less-padding button right edit-search do-not-print"><i class="fa fa-edit"></i> Edit search</a>
            <ul class="inline-list right export do-not-print">
                <li>
                    <a class="right" aria-lablledby="#print" id="printme"><i class="fa fa-print"></i><label id="print">Print</label></a>
                </li>
                <li>
                    <a class="right" aria-lablledby="#pdf"><i class="fa fa-file-pdf-o"></i><label id="pdf">PDF</label></a>
                </li>
                <li>
                    <a class="right" aria-lablledby="#csv"><i class="fa fa-save"></i><label id="cvs">CSV</label></a>
                </li>
            </ul>
        </h2>
        <hr>
        <ol start="{{ page_obj.start_index }}" class="search-results">
            {% for result in object_list %}
            <li>
                {% with doc=result.documents.0 %}
                <h3>
                    <a href="{% url 'person-detail' doc.person_id %}">{{ doc.person }} <span class="{% if doc.uncertain == True %}gray{% else %}green{% endif %}">{{ doc.highest_office }}</span></a>
                </h3>
                {% comment %}
                {% for dd in result.documents %}
                <p>
                    {% highlight dd.text with query html_tag 'strong' max_length 120 %}
                </p>
                {% endfor %}
                {% endcomment %}
                {% endwith %}
            </li>
            {% empty %}
            <li>No results found!</li>
            {% endfor %}
        </ol>
        {% display_pagination querydict page_obj %}
    </div>
</div>
{% endblock main %}

{% block footerscripts %}
    <script type="text/javascript">
        var autocompleteDict = {
            {% for item in autocomplete_facets %}
            "{{ item }}": [
                {% for term in facets.fields|get_item:item %}
                    {% with value=term.0 count=term.1 %}
                        {"name": "{{ value.strip }}", "count": "{{count}}"}
                        {% if not forloop.last %}, {% endif %} {% endwith %}
                {% endfor %}
                ]
                {% if not forloop.last %},{% endif %}
            {% endfor %}
        }
    </script>

    <!-- EasyAutocomplete -->
    <script src="{% static 'vendor/EasyAutocomplete/dist/jquery.easy-autocomplete.js' %}"></script>
    <script src="{% static 'javascripts/search.js' %}"></script>
{% endblock %}
