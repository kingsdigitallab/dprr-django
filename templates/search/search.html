{% extends "base.html" %}
{% load ddh_utils_tags wagtailbase_tags wagtailcore_tags highlight %}

{% block meta_title %}Search Results{% if query %} for {{ query }}{% endif %}{% endblock %}

{% block main %}
<div class="row">
    <div class="large-4 columns facets">
        <form method="get" action=".">
            <section data-section="non-expandable" data-expandable-group-member="facets" id="dprr-filter">
                <h4>Text search</h4>
                <div data-alert class="alert-box info">
                    <i class="fa fa-info-circle"></i> Help text (short!) on how the free text search works.
                    <a href="#" class="close">&times;</a>
                </div>
                <div class="row collapse">
                    <div class="small-9 columns">
                        {{ form.q }}
                    </div>
                    <div class="small-3 columns">
                        <button type="submit" class="postfix button"><i class="fa fa-search"></i></button>
                    </div>
                </div>

                <hr>

                <h4>Filter by <strong>post date</strong></h4>

                {{ form.post_date_from.errors }}
                {{ form.post_date_to.errors }}

                <div class="row range">
                    <div class="small-6 columns">
                        <label>From</label>
                        {{ form.post_date_from }}
                    </div>
                    <div class="small-6 columns">
                        <label>To</label>
                        {{ form.post_date_to }}
                    </div>
                </div>

                {% for facet_value in selected_facets %}
                    <input class="selected_facets_input" type="hidden" name="selected_facets" value="{{ facet_value }}">
                {% endfor %}

                <div class="row range">
                    <div class="large-12 columns">
                        <button type="submit" class="radius expand less-padding secondary">Update search</button>
                    </div>
                </div>

                <hr>

                {% for facet in facets.fields %}
                <div class="panel radius">
                    <div class="panel-head">
                        <h4><i class="fa fa-caret-right right"></i> Filter by <strong>{{ facet }}</strong></h4>
                    </div>
                    <div class="panel-body hidden">
                        <ul class="no-bullet">
                            {% for term in facets.fields|get_item:facet %}
                            {% with value=term.0 count=term.1 %}
                            {% if count > 0 %}
                            <li>
                                <a href="{% add_facet_link querydict facet value %}">
                                    <span class="label radius right">{{ count }}</span>
                                    {{ value }}
                                </a>
                            </li>
                            {% endif %}
                            {% endwith %}
                            {% endfor %}
                        </ul>
                    </div>
                </div>
                {% endfor %}
            </section>
        </form>
    </div>

    <div class="large-8 columns">
        <h1>Search Results <span class="label radius">{{ paginator.count }}</span></h1>

        {% if query or selected_facets or post_date_filter %}
        <div class="panel applied-filter-box">
            <a href="{% url 'haystack_search' %}" class="button less-padding radius right"><i class="fa fa-trash"></i> Clear all</a>

            <h4>Filtering by:</h4>
            <ul class="inline-list applied-filter-list">

                {% if query %}
                <li>
                    <span class="label radius secondary">
                        <a href="{{ remove_text_filter }}" title="Remove filter">Text: {{ query }}
                            <i class="fa fa-times-circle"></i>
                        </a>
                    </span>
                </li>
                {% endif %}

                {% if post_date_filter %}
                <li>
                    <span class="label radius secondary">
                        <a href="{{ post_date_filter.0}}" title="Remove filter">Post Date: {{ post_date_filter.1 }}
                            <i class="fa fa-times-circle"></i>
                        </a>
                    </span>
                </li>
                {% endif %}

                {% for facet in selected_facets %}
                <li>
                    <span class="label radius secondary">
                        {{ facet }}
                        <a href="{% remove_facet_link querydict facet %}">
                            <i class="fa fa-times-circle"></i>
                        </a>
                    </span>
                </li>
                {% endfor %}


            </ul>
        </div>
        {% endif %}

        <ol start="{{page_obj.start_index}}" class="search-results custom-counter">
            {% for result in object_list %}
            <li>
            {% with doc=result.documents.0 %}
                <span class="label radius secondary right">{{ doc.highest_office }}</span>
                <a href="{% url 'person-detail' doc.person_id %}">{{ doc.person }}</a>
                {% for dd in result.documents %}
                <p>
                    {% highlight dd.text with query html_tag 'strong' max_length 120  %}
                </p>
                {% endfor %}
            {% endwith %}
            </li>
            {% empty %}
            <li>No results found!</li>
            {% endfor %}
        </ol>

        {% display_pagination querydict page_obj %}
    </div>

</div>
{% endblock main %}
